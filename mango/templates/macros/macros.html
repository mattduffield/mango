{% set label_css = "block text-gray-700 text-sm font-bold mb-2" %}
{% set list_label_css = "flex-1 text-gray-700 text-sm font-bold mb-2" %}

{% macro crispy_form_view(form) %}
  {% for field in form %}
    <div class="mb-4">
      {{ field.label(class=label_css) }}
      {{ field() }}
      {% if field.errors %}
        <ul class="errors">{% for error in field.errors %}<li>{{ error }}</li>{% endfor %}</ul>
      {% endif %}
      {% if field.description %}
        <small>{{field.description}}</small>
      {% endif %}
    </div>
  {% endfor %}
{% endmacro %}

{% macro crispy_list_layout(view, form, data) %}
  {% if view.list_layout and view.list_layout['field_list'] %}
    {{ crispy_table_layout(view, form=form, data=data, items=view.list_layout['field_list']) }}
  {% else %}
    {{ crispy_table_view(view, form=form, data=data) }}
  {% endif %}
{% endmacro %}

{% macro crispy_table_view(view, form, data) %}
  <table class="min-w-full divide-y divide-gray-200 shadow-md"
    hx-indicator=".htmx-indicator">
    <thead class="bg-gray-50">
      <tr>
        {% for field in form %}
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            {{ field.label.text }}
          </th>
        {% endfor %}
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>        
      </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200">
      {% for object in data %}
        <tr class="intro-y">
          {% for field in form %}
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              {% if object[field.name]|is_datetime %}
                {{ object[field.name]|to_date }}
              {% elif object[field.name]|is_list or field|is_query_select_field %}
                {{ field|db_lookup(data=object[field.name]) }}
              {% else %}
                {{ object[field.name] }}
              {% endif %}
            </td>
          {% endfor %}
          <td class="flex justify-between px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <a class="cursor-pointer" 
              hx-get="/{{ view.model_name }}/{{ object['_id'] }}" 
              hx-target="#viewport" 
              hx-swap="innerHTML" 
              hx-push-url="true" 
              hx-indicator="#content-loader">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
              </svg>
            </a> 
            <a class="cursor-pointer"
              hx-get="/{{ view.model_name }}/{{ object['_id'] }}/delete" 
              hx-target="#viewport" 
              hx-swap="innerHTML" 
              hx-push-url="true" 
              hx-indicator="#content-loader">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </a>
          </td>
        </tr>
      {% else %}
        <tr class="intro-y">
          <td colspan="100%" class="px-6 py-4 text-center h-36">
            No Data
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endmacro %}

{% macro crispy_table_layout(view, form, data, items=[]) %}
  <table class="min-w-full divide-y divide-gray-200 shadow-md"
    hx-indicator=".htmx-indicator">
    <thead class="bg-gray-50">
      <tr>
        {% for item in items %}
          {% set field = form[item] %}
          <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            {{ field.label.text }}
          </th>
        {% endfor %}
        <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>        
      </tr>
    </thead>
    <tbody class="bg-white divide-y divide-gray-200">
      {% for object in data %}
        <tr class="intro-y">
          {% for item in items %}
            {% set field = form[item] %}
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
              {% if object[field.name]|is_datetime %}
                {{ object[field.name]|to_date }}
              {% elif object[field.name]|is_list or field|is_query_select_field %}
                {{ field|db_lookup(data=object[field.name]) }}
              {% else %}
                {{ object[field.name] }}
              {% endif %}
            </td>
          {% endfor %}
          <td class="flex justify-between px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
            <a class="cursor-pointer" 
              hx-get="/{{ view.model_name }}/{{ object['_id'] }}" 
              hx-target="#viewport" 
              hx-swap="innerHTML" 
              hx-push-url="true" 
              hx-indicator="#content-loader">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path>
              </svg>
            </a> 
            <a class="cursor-pointer"
              hx-get="/{{ view.model_name }}/{{ object['_id'] }}/delete" 
              hx-target="#viewport" 
              hx-swap="innerHTML" 
              hx-push-url="true" 
              hx-indicator="#content-loader">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </a>
          </td>
        </tr>
      {% else %}
        <tr class="intro-y">
          <td colspan="100%" class="px-6 py-4 text-center h-36">
            No Data
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
{% endmacro %}

{% macro crispy_form_page_layout(form, page_layout) %}
  {% if page_layout.items %}
    {{ crispy_form_layout(form, items=page_layout['items']) }}
    {# {{ crispy_tree_view(form, items=page_layout['items']) }} #}
  {% endif %}
{% endmacro %}

{% macro crispy_form_layout_orig(form, items=[]) %}
  {% for item in items %}
    {% if item['element_type'] == 'element' %}
      <div class="{{ item['css_class'] }}">
        {% if item['items']|length > 0 %}
          {{ crispy_form_layout(form, items=item['items']) }}
        {% endif %}
      </div>
    {% else %}
      {% set field = form[item['field']] %}
      <div id="wrapper_{{ field.id }}" class="mb-4 flex-1">
        {{ field.label(class=label_css) }}
        {% if field|is_fieldlist %}
          --FIELDLIST--
          <button type="button" 
            class="intro-x text-lg text-white bg-green-500 hover:bg-green-600 px-2 xpy-1 rounded-md">
            +
          </button>
          {% for sub_field in field %}
            --SUB FIELDLIST--
            <button type="button" 
              class="intro-x text-lg text-white bg-indigo-500 hover:bg-indigo-600 px-2 xpy-1 rounded-md">
              +
            </button>
            {{ sub_field() }}
          {% endfor %}
        {% else %}
          {{ field() }}
        {% endif %}
      </div>
    {% endif %}
  {% endfor %}
{% endmacro %}

{% macro crispy_form_layout(form, items=[]) %}
  {% for item in items %}
    {% if item['element_type'] == 'element' %}
      <div class="{{ item['css_class'] }}">
        {% if item['items']|length > 0 %}
          {{ crispy_form_layout(form, items=item['items']) }}
        {% endif %}
      </div>
    {% else %}
      {% set field = form[item['field']] %}
      <div id="wrapper_{{ field.id }}" class="mb-4 flex-1">
        {% if field|is_fieldlist %}
          <div class="flex flex-1">
            {{ field.label(class=list_label_css) }}        
            <button type="button" 
              class="intro-x text-lg text-white bg-green-500 hover:bg-green-600 px-2 xpy-1 rounded-md"
              x_="on click 
                get the #row-template's innerHTML then
                put it at the end of the #validator-body
                _hyperscript.processNode(the last <tr />)"
              _="on click addDynamicRowByTemplate(my, '#{{ field.name }}-body')">
              +
            </button>
          </div>
          <template id="row-template">
            <tr>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                <input id='' name='' type='text' autofocus="true" />
              </td>
              <td class="flex justify-center px-6 py-4 whitespace-nowrap text-sm font-medium w-full">
                <button class="cursor-pointer"
                  _="on click remove the closest <tr/>">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                  </svg>
                </button>
              </td>
            </tr>
          </template>
          <table class="min-w-full divide-y divide-gray-200 shadow-md">
            <thead class="bg-gray-50">
              {% for sub_field in field %}
                {% if sub_field|is_form_field %}
                  {% for sub_field_th in sub_field.form %}
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                      {{ sub_field_th.name|to_field_list_label }}
                    </th>
                  {% endfor %}
                {% else %}
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    Entry
                  </th>
                {% endif %}
              {% else %}
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  N/A {{ field.name }}
                </th>
              {% endfor %}
              <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-5">
                Actions
              </th>
            </thead>
            <tbody id="{{ field.name }}-body" class="bg-white divide-y divide-gray-200">
              {% for sub_field in field %}
                {% if sub_field|is_form_field %}
                  <tr class="intro-y">
                    {% for sub_field_td in sub_field.form %}
                      <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {{ sub_field_td() }}
                      </td>
                    {% endfor %}
                    <td class="flex justify-center px-6 py-4 whitespace-nowrap text-sm font-medium w-full">
                      <button class="cursor-pointer"
                        _="on click remove the closest <tr/>">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                      </button>
                    </td>
                  </tr>
                {% else %}
                  <tr class="intro-y">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {{ sub_field() }}
                    </td>
                    <td class="flex justify-center px-6 py-4 whitespace-nowrap text-sm font-medium w-full">
                      <button class="cursor-pointer"
                        _="on click remove the closest <tr/>">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                      </button>
                    </td>
                  </tr>
                {% endif %}
              {% else %}
                <tr class="intro-y">
                  <td colspan="100%" class="px-6 py-4 text-center h-36">
                    No Data
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        {% else %}
          {{ field.label(class=label_css) }}
          {{ field() }}
        {% endif %}
      </div>
    {% endif %}
  {% endfor %}
{% endmacro %}

{% macro crispy_tree_view(form, items=[], is_nested=False) %}
  <ul class="{% if is_nested %}hidden{% endif %}">
    {% for item in items %}
      <li class="ml-5">
        {% if item['items']|length > 0 %}
          <span class="cursor-pointer caret"
            _="on click
              toggle .caret-down
              toggle .active on the next .hidden within my parentElement
              ">
            {% if item['element_type'] != 'field' %}
              {{ item['element_type']|upper }}
            {% endif %}
          </span>
        {% else %}
          {% if item['element_type'] != 'field' %}
            {{ item['element_type']|upper }}
          {% else %}
            {# {% set field = form[item['field']] %} #}
            {# {{ field.label(class=label_css) }}#}
            {# {{ field() }} #}
            {{ item['field'] }}
          {% endif %}
        {% endif %}
        {% if item['items'] %}
          {{ crispy_tree_view(form, items=item['items'], is_nested=True) }}
        {% endif %}
      </li>
    {% endfor %}
  </ul>
{% endmacro %}
